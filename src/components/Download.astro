<section id="download">
  <div class="container" data-aos="fade-up">
    <h2>Descarga la App</h2>
    <p>Disponible para Android. Empieza tu aventura universitaria hoy mismo.</p>
    <a href="apk/ViveLaUCA.apk" class="btn" id="downloadButton"
      >Descargar ahora</a
    >
    <div id="progressContainer" style="display: none;">
      <div
        id="progressBar"
        style="width: 0%; height: 20px; background: #ff9900; border-radius: 5px;"
      >
      </div>
    </div>
    <p id="progressText" style="display: none;">Descargando... 0%</p>
    <p id="errorText" style="display: none; color: red;"></p>
    <button id="retryButton" style="display: none;" class="btn"
      >Reintentar descarga</button
    >
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const downloadButton = document.getElementById("downloadButton");
    const progressContainer = document.getElementById("progressContainer");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const errorText = document.getElementById("errorText");
    const retryButton = document.getElementById("retryButton");
    let downloadStarted = false;

    const initiateDownload = () => {
      if (downloadStarted) return;

      downloadStarted = true;
      progressContainer.style.display = "block";
      progressText.style.display = "block";
      errorText.style.display = "none";
      retryButton.style.display = "none";

      const xhr = new XMLHttpRequest();
      xhr.open("GET", "apk/ViveLaUCA.apk", true);
      xhr.responseType = "blob";

      xhr.onprogress = (event) => {
        if (event.lengthComputable) {
          const percentComplete = Math.round(
            (event.loaded / event.total) * 100
          );
          progressBar.style.width = `${percentComplete}%`;
          progressText.textContent = `Descargando... ${percentComplete}%`;
          document.title = `Descargando... ${percentComplete}%`;
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          const link = document.createElement("a");
          link.href = URL.createObjectURL(xhr.response);
          link.download = "ViveLaUCA.apk";
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(link.href);

          document.title = "Descarga completa";
          progressText.textContent = "Descarga completa";

          // Esperar hasta que el usuario haya confirmado la descarga antes de redirigir
          window.addEventListener("focus", () => {
            setTimeout(() => {
              window.location.href = "/Instructions";
            }, 1000);
          });
        } else {
          handleDownloadError(`Error ${xhr.status}: ${xhr.statusText}`);
        }
      };

      xhr.onerror = () => {
        handleDownloadError("Error de red. Por favor, intÃ©ntalo de nuevo.");
      };

      xhr.send();
    };

    const handleDownloadError = (message) => {
      downloadStarted = false;
      progressContainer.style.display = "none";
      progressText.style.display = "none";
      errorText.textContent = message;
      errorText.style.display = "block";
      retryButton.style.display = "inline-block";
    };

    downloadButton.addEventListener("click", (e) => {
      e.preventDefault();
      initiateDownload();
    });

    retryButton.addEventListener("click", (e) => {
      e.preventDefault();
      initiateDownload();
    });
  });
</script>

<style>
  #download {
    padding: 30px 0;
    text-align: center;
    background: #f9f9f9;
  }

  #download h2 {
    font-size: 2em;
    margin-bottom: 20px;
  }

  #download p {
    font-size: 1.1em;
    margin-bottom: 30px;
    color: #666;
  }

  #download .btn {
    background: #ff9900;
    color: white;
    padding: 15px 30px;
    text-decoration: none;
    border-radius: 5px;
    transition: background 0.3s;
    margin: 0 10px;
    font-weight: bold;
  }

  #download .btn:hover {
    background: #e68a00;
  }

  #progressContainer {
    width: 100%;
    background: #e0e0e0;
    border-radius: 5px;
    margin: 20px 0;
  }

  #progressText {
    font-size: 1em;
    color: #666;
    margin-top: 10px;
  }
</style>
